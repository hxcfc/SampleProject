# Build
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /src
COPY . .

# Build args for JWT configuration
ARG JWT_SECRET_KEY
ARG JWT_ISSUER
ARG JWT_AUDIENCE
ARG JWT_EXPIRATION_MINUTES
ARG JWT_REFRESH_TOKEN_EXPIRATION_DAYS
ARG JWT_USE_COOKIES
ARG JWT_ACCESS_TOKEN_COOKIE_NAME
ARG JWT_REFRESH_TOKEN_COOKIE_NAME
ARG JWT_COOKIE_DOMAIN
ARG JWT_COOKIE_PATH
ARG JWT_SECURE_COOKIES
ARG JWT_SAME_SITE_MODE

# Set environment variables for build
ENV JWT_SECRET_KEY=$JWT_SECRET_KEY
ENV JWT_ISSUER=$JWT_ISSUER
ENV JWT_AUDIENCE=$JWT_AUDIENCE
ENV JWT_EXPIRATION_MINUTES=$JWT_EXPIRATION_MINUTES
ENV JWT_REFRESH_TOKEN_EXPIRATION_DAYS=$JWT_REFRESH_TOKEN_EXPIRATION_DAYS
ENV JWT_USE_COOKIES=$JWT_USE_COOKIES
ENV JWT_ACCESS_TOKEN_COOKIE_NAME=$JWT_ACCESS_TOKEN_COOKIE_NAME
ENV JWT_REFRESH_TOKEN_COOKIE_NAME=$JWT_REFRESH_TOKEN_COOKIE_NAME
ENV JWT_COOKIE_DOMAIN=$JWT_COOKIE_DOMAIN
ENV JWT_COOKIE_PATH=$JWT_COOKIE_PATH
ENV JWT_SECURE_COOKIES=$JWT_SECURE_COOKIES
ENV JWT_SAME_SITE_MODE=$JWT_SAME_SITE_MODE

RUN dotnet restore
RUN dotnet publish SampleProject/SampleProject.csproj -c Release -o /app/publish --no-restore

# Runtime
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS final
WORKDIR /app
COPY --from=build /app/publish .
EXPOSE 80
ENTRYPOINT ["dotnet", "SampleProject.dll"]
